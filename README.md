## Скрипт для конвертации объектов SEAF TA в объекты DrawIO 

> Важно для версии 1.8: поддержка модели **SEAF1 отключена**. Поддерживается только модель с именованием `seaf.company.ta.*`.

 - seaf2drawio.py — скрипт для конвертации yaml‑объектов метамодели SEAF в объекты DrawIO для автоматизации формирования диаграммы технической архитектуры (схема Р41).
 - drawio2seaf.py — скрипт для извлечения метаданных из объектов DrawIO (схема Р41) и трансформации их в метамодель SEAF (v. 1.30 и выше)

### Для начала работы необходимо 

 1. Python версии 3.9 и выше
 2. Создать виртуальное окружение и установить зависимости из `requirements.txt`

#### Подготовка окружения

```bash
python3 -m venv .venv
source .venv/bin/activate          # Windows: .venv\Scripts\activate
python -m pip install --upgrade pip
pip install -r requirements.txt
```

*Для выхода из окружения используйте `deactivate`.*
 
### Конфигурация работы скрипта  *****seaf2drawio*.py****
  Конфигурация скрипта осуществляется путем изменения переменных в файле `config.yaml`.

| Переменная           | Назначение                                                                                                                                                                                                                           |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| ***data_yaml_file*** | Путь к файлу данных SEAF или директории с файлами.<br/>**Новое:** Можно указать путь к директории (например, `data/example/`). Скрипт автоматически загрузит все файлы `.yaml` и `.yml` из неё, игнорируя файлы, начинающиеся с `_` или `.`. |
| ***drawio_pattern*** | Шаблон DrawIO файла, используемый для построения диаграммы.<br/>(default: `data/base.drawio`)                                                                                                                                        |
| ***output_file***    | Файл Draw IO диаграммы сформированной скриптом.<br/>(default: `result/Sample_graph.drawio`)                                                                                                                                          |
| ***verify_generation*** | Включает автоматическую проверку соответствия сгенерированной диаграммы исходным YAML-данным. Выводит отчет о пропущенных объектах.                                                                                               |

###### * Если переменные в файле не заполнены, то по умолчанию используются default значения.
###### * Если вместо входного шаблона Draw IO (`data/base.drawio`) использовать файл с ранее сформированной скриптом диаграммы, то скрипт не изменит ранее сделанную разметку объектов, а только обновит данные существующих объектов и дополнит новыми объектами.

#### Переменные конфигурации скрипта можно установить в командной строке:

`python -X utf8 seaf2drawio.py [-h] [-s SRC] [-d DST] [-p PATTERN] [--debug]`

**Параметры командной строки:**

*   `-h, --help`: показать справку и выйти
*   `-s SRC, --src SRC`: путь к файлу или директории данных SEAF (переопределяет `data_yaml_file`)
*   `-d DST, --dst DST`: путь и имя файла вывода результатов (переопределяет `output_file`)
*   `-p PATTERN, --pattern PATTERN`: шаблон drawio
*   `--debug`: включить подробный режим отладки (выводит детальный отчет о причинах пропуска объектов при верификации)

###### При исполнении скрипта в Windows рекомендуется использовать ключ `python -X utf8` или переменную окружения `set PYTHONUTF8=1`.

#### Переменные командной строки имеют приоритет перед переменными файла конфигурации.

### Порядок описания объектов SEAF (Иерархия)

Для корректной работы скрипта и отрисовки связей важен порядок обработки (хотя скрипт старается обрабатывать зависимости автоматически). Основная иерархия с новыми именами схем (`seaf.company.ta.*`):

    -*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
    |- Регион                                   - seaf.company.ta.services.dc_regions
    |  |- Зона доступности                      - seaf.company.ta.services.dc_azs
    |  |  |- Офис/ЦОД                           - seaf.company.ta.services.dc_offices / seaf.company.ta.services.dcs
    |  |  |  |- Зоны безопасности               - seaf.company.ta.services.network_segments
    |  |  |  |  |- Сети                         - seaf.company.ta.services.networks
    |  |  |  |  |- Сетевые устройства           - seaf.company.ta.components.networks (LB, Firewalls, Routers)
    |  |  |  |  |- Вычислительные сервисы       - seaf.company.ta.services.compute_services
    |  |  |  |  |- Кластеры виртуализации       - seaf.company.ta.services.cluster_virtualizations
    |  |  |  |  |- Kubernetes                   - seaf.company.ta.services.k8s
    |  |  |  |  |- Мониторинг, Бэкап            - seaf.company.ta.services.monitorings, backups


######  * Типы зон безопасности и сетевых устройст описываются в модели SEAF, описание объектов можно посмотреть в файлах примерах (`data/example/*.yaml`)

###### * Связывание объектов осуществляется через атрибут ***network_connection*** объекта описания сетевого устройства ***seaf.company.ta.components.networks***



### Конфигурация работы скрипта  *****drawio2seaf.py*****

Конфигурация скрипта осуществляется путем изменения переменных в файле config.yaml
  
| Переменная          | Назначение                                                                                                                  |
|---------------------|-----------------------------------------------------------------------------------------------------------------------------|
| ***drawio_file***   | Файл файл содержащий диаграмму Р41 ранее сформированную скриптом seaf2drawio.py <br/>(default: .result/Sample_graph.drawio) |
| ***schema_file***   | Файл содержит схему объектов SEAF <br/>(default: .data/seaf_schema.yaml)                                                    | 
| ***output_file***   | Файл yaml содержащий объекты в формате SEAF <br/>(default: .result/seaf.yaml)                                               |

#### Переменные конфигурации скрипта можно установить в командной строке в следующем виде:

###### usage: drawio2seaf.py [-h] [-s SRC] [-d DST] [-p PATTERN]

### Инструменты автоматизации (Вспомогательные скрипты)

В директории `scripts/` находятся утилиты для проверки производительности и улучшения лейаута диаграмм.

#### 1. `scale_drawio_services.py` (Stress Test)
Дублирует технические сервисы на диаграмме для проверки производительности рендеринга и скриптов лейаута.
**Использование:**
```bash
python scripts/scale_drawio_services.py -i result/Sample_graph.drawio -o result/stress_test.drawio --factor 3
```
*   `--factor`: во сколько раз увеличить количество объектов (default: 3).

#### 2. `layout_tech_services.py` (Auto Layout)
Автоматически группирует и размещает технические сервисы (Compute, K8s, DB, etc.) внутри сетевых сегментов, предотвращая наложение объектов.
**Использование:**
```bash
python scripts/layout_tech_services.py -i result/Sample_graph.drawio
```
Скрипт анализирует связи и метаданные, чтобы умно сгруппировать сервисы в "контейнеры" внутри сегментов.

### Пример успешного запуска (Log Output)

```text
> Формирую диаграмму страницы Main Schema ........
> Формирую диаграмму страницы Sber Cloud DC ....................................
...
--- Verification summary (by schema):

  - seaf.company.ta.services.compute_services: expected=32, drawn_unique=32 -> OK
  - seaf.company.ta.services.networks: expected=53, drawn_unique=53 -> OK
  ...
Result: GENERATION MATCHES YAML (by schema)
```

### Ограничения версии 1.8

1. Поддержка SEAF1 (`seaf.ta.*`) отключена.
2. Входные данные, паттерны и обратная трансформация `drawio2seaf.py` работают с `seaf.company.ta.*`.
3. Для обратной трансформации используйте `data/seaf_schema.yaml` из текущей ветки.

### Возможные сценарии использования скриптов

##### 1. Создание диаграммы DrawIO (Р41) из yaml файла SEAF (seaf2drawio.py)
##### 2. Дополнение объектов, изменение данных ранее созданной диаграммы (Р41) данными из yaml файла SEAF (seaf2drawio.py)
######   при этом ранее сделанная разметка, позиционирование объектов DrawIO не меняется, обновляются данные и добавляются новые объекты 
##### 3. Редактирование ранее созданной с помощью скрипта (seaf2drawio.py) диаграммы, добавление новых объектов с последующей трансформацией данных с помощью скрипта (drawio2seaf.py) в yaml формат SEAF
##### 4. Создание диаграммы с чистого листа используя шаблоны объектов DrawIO из библиотеки (Избранное_Р41.xml) последующей трансформацией данных в yaml формат SEAF
